<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - راحة بيو</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --accent: #2e8b57;
            --accent-hover: #228b22;
        }

        [data-theme="dark"] {
            --bg-primary: #121a12;
            --bg-secondary: #172317;
            --bg-card: #1c2a1c;
            --bg-input: #243524;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #3d332a;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            direction: rtl;
            transition: background-color 0.3s, color 0.3s;
        }

        .admin-header {
            background: linear-gradient(135deg, #2e8b57 0%, #228b22 100%);
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
        }

        .admin-header .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .admin-header a, .admin-header button {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
        }

        .admin-header a:hover, .admin-header button:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 90px 15px 30px;
        }

        /* Tabs */
        .tabs-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 3px 15px var(--shadow-color);
        }

        .tab-btn {
            padding: 10px 18px;
            background: var(--bg-input);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover, .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tab-btn .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 15px var(--shadow-color);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover { transform: translateY(-3px); }
        .stat-card i { font-size: 26px; margin-bottom: 8px; color: var(--accent); }
        .stat-card h3 { font-size: 24px; margin-bottom: 3px; }
        .stat-card p { color: var(--text-secondary); font-size: 12px; }

        /* Orders */
        .orders-section {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: 0 3px 15px var(--shadow-color);
            overflow: hidden;
        }

        .orders-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            background: var(--bg-input);
        }

        .orders-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .refresh-btn {
            padding: 8px 18px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .refresh-btn:hover { transform: scale(1.05); }

        .orders-list {
            max-height: 70vh;
            overflow-y: auto;
        }

        .order-card {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .order-card:hover { background: var(--bg-input); }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }

        .order-id { font-weight: 700; color: var(--accent); font-size: 14px; }
        .order-date { color: var(--text-secondary); font-size: 12px; }

        .order-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1e7dd; color: #0f5132; }
        .status-shipped { background: #cff4fc; color: #055160; }
        .status-delivered { background: #d1e7dd; color: #0f5132; }
        .status-cancelled { background: #f8d7da; color: #842029; }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .customer-info div {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customer-info i { color: var(--accent); width: 16px; }

        .order-products {
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .order-products h4 {
            margin-bottom: 6px;
            color: var(--accent);
            font-size: 12px;
        }

        .order-total {
            font-weight: 700;
            color: var(--accent);
            font-size: 16px;
            margin: 10px 0;
        }

        .order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .btn-confirm { background: #198754; color: white; }
        .btn-ship { background: #0dcaf0; color: #000; }
        .btn-deliver { background: #198754; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-delete { background: #6c757d; color: white; }

        .action-btn:hover { transform: scale(1.05); opacity: 0.9; }

        .empty-orders {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-orders i { font-size: 50px; margin-bottom: 15px; opacity: 0.5; }

        /* Products Section */
        .add-product-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .add-product-btn:hover { transform: scale(1.05); }

        .products-grid-admin {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .product-card-admin {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 15px var(--shadow-color);
            transition: all 0.3s;
        }

        .product-card-admin:hover { transform: translateY(-5px); }

        .product-card-admin img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .product-card-admin .content {
            padding: 15px;
        }

        .product-card-admin h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .product-card-admin .price {
            color: var(--accent);
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .product-card-admin .actions {
            display: flex;
            gap: 8px;
        }

        .product-card-admin .edit-btn,
        .product-card-admin .delete-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .product-card-admin .edit-btn {
            background: var(--accent);
            color: white;
        }

        .product-card-admin .delete-btn {
            background: #dc3545;
            color: white;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body { padding: 20px; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group textarea { min-height: 80px; resize: vertical; }

        .image-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            overflow: hidden;
            background: var(--bg-input);
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview span {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .submit-btn:hover { transform: scale(1.02); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: #198754; }
        .toast.error { background: #dc3545; }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header h1 { font-size: 14px; }
            .admin-header a, .admin-header button { padding: 6px 12px; font-size: 11px; }
            .container { padding-top: 100px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .customer-info { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <h1><i class="fas fa-leaf"></i> لوحة تحكم راحة بيو</h1>
            <div class="header-buttons">
                <button onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span>الوضع</span>
                </button>
                <a href="/">
                    <i class="fas fa-store"></i>
                    <span>المتجر</span>
                </a>
                <button onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>خروج</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('orders')">
                <i class="fas fa-shopping-bag"></i>
                الطلبات
                <span class="count" id="totalOrdersCount">0</span>
            </button>
            <button class="tab-btn" onclick="switchTab('products')">
                <i class="fas fa-leaf"></i>
                المنتجات
            </button>
        </div>

        <!-- Orders Tab -->
        <div class="tab-content active" id="ordersTab">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-shopping-bag"></i>
                    <h3 id="totalOrders">0</h3>
                    <p>إجمالي الطلبات</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <h3 id="pendingOrders">0</h3>
                    <p>في الانتظار</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="confirmedOrders">0</h3>
                    <p>مؤكدة</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-truck"></i>
                    <h3 id="shippedOrders">0</h3>
                    <p>في الطريق</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-box"></i>
                    <h3 id="deliveredOrders">0</h3>
                    <p>تم التسليم</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-coins"></i>
                    <h3 id="totalRevenue">0</h3>
                    <p>الإيرادات (د.ج)</p>
                </div>
            </div>

            <!-- Order Status Tabs -->
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="filterOrders('all')">
                    <i class="fas fa-list"></i>
                    الكل
                </button>
                <button class="tab-btn" onclick="filterOrders('pending')">
                    <i class="fas fa-clock"></i>
                    في الانتظار
                </button>
                <button class="tab-btn" onclick="filterOrders('confirmed')">
                    <i class="fas fa-check"></i>
                    مؤكدة
                </button>
                <button class="tab-btn" onclick="filterOrders('shipped')">
                    <i class="fas fa-truck"></i>
                    في الطريق
                </button>
                <button class="tab-btn" onclick="filterOrders('delivered')">
                    <i class="fas fa-box"></i>
                    تم التسليم
                </button>
                <button class="tab-btn" onclick="filterOrders('cancelled')">
                    <i class="fas fa-times"></i>
                    ملغاة
                </button>
            </div>

            <!-- Orders Section -->
            <div class="orders-section">
                <div class="orders-header">
                    <h2><i class="fas fa-clipboard-list"></i> قائمة الطلبات</h2>
                    <button class="refresh-btn" onclick="loadOrders()">
                        <i class="fas fa-sync-alt"></i>
                        تحديث
                    </button>
                </div>
                <div class="orders-list" id="ordersList">
                    <div class="empty-orders">
                        <i class="fas fa-inbox"></i>
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div class="tab-content" id="productsTab">
            <button class="add-product-btn" onclick="openProductModal()">
                <i class="fas fa-plus"></i>
                إضافة منتج جديد
            </button>
            <div class="products-grid-admin" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-leaf"></i> <span id="modalTitle">إضافة منتج</span></h3>
                <button class="close-modal" onclick="closeProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm" onsubmit="saveProduct(event)">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label>اسم المنتج *</label>
                        <input type="text" id="productName" required placeholder="مثال: عسل طبيعي">
                    </div>
                    <div class="form-group">
                        <label>السعر (د.ج) *</label>
                        <input type="number" id="productPrice" required placeholder="2500">
                    </div>
                    <div class="form-group">
                        <label>السعر القديم (د.ج) - اختياري</label>
                        <input type="number" id="productOldPrice" placeholder="3000">
                    </div>
                    <div class="form-group">
                        <label>الشارة (Badge)</label>
                        <input type="text" id="productBadge" placeholder="مثال: جديد، عرض خاص">
                    </div>
                    <div class="form-group">
                        <label>وصف المنتج</label>
                        <textarea id="productDescription" placeholder="وصف مختصر للمنتج..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>صورة المنتج</label>
                        <input type="file" id="productImage" accept="image/*" onchange="previewImage(event)">
                        <div class="image-preview" id="imagePreview">
                            <span>معاينة الصورة</span>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i>
                        حفظ المنتج
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        let orders = [];
        let products = [];
        let currentFilter = 'all';
        let editingProductId = null;

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('adminTheme', next);
        }

        function loadTheme() {
            const saved = localStorage.getItem('adminTheme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminAuth');
            window.location.href = '/';
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tab + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Filter orders
        function filterOrders(status) {
            currentFilter = status;
            document.querySelectorAll('.tabs-nav .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderOrders();
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                orders = await response.json();
                updateStats();
                renderOrders();
            } catch (error) {
                showToast('خطأ في تحميل الطلبات', 'error');
            }
        }

        // Update stats
        function updateStats() {
            const stats = {
                total: orders.length,
                pending: orders.filter(o => o.status === 'pending').length,
                confirmed: orders.filter(o => o.status === 'confirmed').length,
                shipped: orders.filter(o => o.status === 'shipped').length,
                delivered: orders.filter(o => o.status === 'delivered').length,
                revenue: orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + (o.totalPrice || o.total || 0), 0)
            };

            document.getElementById('totalOrders').textContent = stats.total;
            document.getElementById('pendingOrders').textContent = stats.pending;
            document.getElementById('confirmedOrders').textContent = stats.confirmed;
            document.getElementById('shippedOrders').textContent = stats.shipped;
            document.getElementById('deliveredOrders').textContent = stats.delivered;
            document.getElementById('totalRevenue').textContent = stats.revenue.toLocaleString();
            document.getElementById('totalOrdersCount').textContent = stats.total;
        }

        // Render orders
        function renderOrders() {
            const container = document.getElementById('ordersList');
            let filtered = orders;

            if (currentFilter !== 'all') {
                filtered = orders.filter(o => o.status === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <i class="fas fa-inbox"></i>
                        <p>لا توجد طلبات</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">#${order.id}</div>
                            <div class="order-date">${new Date(order.date).toLocaleString('ar-DZ')}</div>
                        </div>
                        <span class="order-status status-${order.status}">
                            ${getStatusText(order.status)}
                        </span>
                    </div>
                    <div class="customer-info">
                        <div><i class="fas fa-user"></i> ${order.customer.firstName} ${order.customer.lastName}</div>
                        <div><i class="fas fa-phone"></i> ${order.customer.phone}</div>
                        <div><i class="fas fa-envelope"></i> ${order.customer.email}</div>
                        <div><i class="fas fa-map-marker-alt"></i> ${order.customer.wilaya}</div>
                    </div>
                    <div class="order-products">
                        <h4><i class="fas fa-shopping-bag"></i> المنتجات:</h4>
                        ${order.items.map(item => `${item.name} × ${item.quantity}`).join(' | ')}
                    </div>
                    <div class="order-total">المجموع: ${(order.totalPrice || order.total || 0).toLocaleString()} د.ج</div>
                    <div class="order-actions">
                        ${getActionButtons(order)}
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const texts = {
                pending: 'في الانتظار',
                confirmed: 'مؤكدة',
                shipped: 'في الطريق',
                delivered: 'تم التسليم',
                cancelled: 'ملغاة'
            };
            return texts[status] || status;
        }

        function getActionButtons(order) {
            let buttons = '';
            
            if (order.status === 'pending') {
                buttons += `<button class="action-btn btn-confirm" onclick="updateStatus('${order.id}', 'confirmed')"><i class="fas fa-check"></i> تأكيد</button>`;
                buttons += `<button class="action-btn btn-cancel" onclick="updateStatus('${order.id}', 'cancelled')"><i class="fas fa-times"></i> إلغاء</button>`;
            } else if (order.status === 'confirmed') {
                buttons += `<button class="action-btn btn-ship" onclick="updateStatus('${order.id}', 'shipped')"><i class="fas fa-truck"></i> شحن</button>`;
            } else if (order.status === 'shipped') {
                buttons += `<button class="action-btn btn-deliver" onclick="updateStatus('${order.id}', 'delivered')"><i class="fas fa-box"></i> تم التسليم</button>`;
            }
            
            buttons += `<button class="action-btn btn-delete" onclick="deleteOrder('${order.id}')"><i class="fas fa-trash"></i> حذف</button>`;
            
            return buttons;
        }

        // Update order status
        async function updateStatus(orderId, status) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showToast('تم تحديث حالة الطلب', 'success');
                    loadOrders();
                }
            } catch (error) {
                showToast('خطأ في تحديث الطلب', 'error');
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟')) return;

            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('تم حذف الطلب', 'success');
                    loadOrders();
                }
            } catch (error) {
                showToast('خطأ في حذف الطلب', 'error');
            }
        }

        // Products functions
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                products = await response.json();
                renderProducts();
            } catch (error) {
                showToast('خطأ في تحميل المنتجات', 'error');
            }
        }

        function renderProducts() {
            const container = document.getElementById('productsGrid');
            container.innerHTML = products.map(product => `
                <div class="product-card-admin">
                    <img src="${product.image || 'https://via.placeholder.com/300x200?text=منتج'}" alt="${product.name}">
                    <div class="content">
                        <h3>${product.name}</h3>
                        <div class="price">${product.price.toLocaleString()} د.ج</div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="delete-btn" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'إضافة منتج';
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '<span>معاينة الصورة</span>';
            document.getElementById('productOldPrice').value = '';
            document.getElementById('productBadge').value = '';
            document.getElementById('productModal').classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'تعديل المنتج';
            document.getElementById('productId').value = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productOldPrice').value = product.oldPrice || '';
            document.getElementById('productBadge').value = product.badge || '';
            document.getElementById('productDescription').value = product.description || '';
            
            if (product.image) {
                document.getElementById('imagePreview').innerHTML = `<img src="${product.image}" alt="Preview">`;
            }
            
            document.getElementById('productModal').classList.add('active');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveProduct(event) {
            event.preventDefault();

            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const oldPrice = document.getElementById('productOldPrice').value;
            const badge = document.getElementById('productBadge').value;
            const description = document.getElementById('productDescription').value;
            
            // Convert image to base64 if selected
            let imageBase64 = null;
            const imageFile = document.getElementById('productImage').files[0];
            if (imageFile) {
                imageBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageFile);
                });
            }

            const productData = {
                nameAr: name,
                price: price,
                oldPrice: oldPrice || null,
                badge: badge || '',
                descriptionAr: description,
                image: imageBase64
            };

            try {
                let url, method;
                if (editingProductId) {
                    url = `/api/products/${editingProductId}`;
                    method = 'PUT';
                } else {
                    url = '/api/products/add';
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    showToast(editingProductId ? 'تم تحديث المنتج' : 'تم إضافة المنتج', 'success');
                    closeProductModal();
                    loadProducts();
                } else {
                    showToast('خطأ في حفظ المنتج', 'error');
                }
            } catch (error) {
                showToast('خطأ في حفظ المنتج', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;

            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('تم حذف المنتج', 'success');
                    loadProducts();
                }
            } catch (error) {
                showToast('خطأ في حذف المنتج', 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMessage').textContent = message;
            
            toast.className = `toast ${type}`;
            icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadOrders();
            loadProducts();
        });
    </script>
</body>
</html>
